[1m[36m┌[39m[0m[36m────────────────────────────────────────────────────────────[39m[1m[36m┐[39m[0m
[1m[36m│[39m[0m [1m[96m⚙️  Valknut v1.2.2 - AI-Powered Code Analysis[39m[0m [1m[36m│[39m[0m
[1m[36m└[39m[0m[36m────────────────────────────────────────────────────────────[39m[1m[36m┘[39m[0m

[32m✅ Configuration loaded with comprehensive analysis enabled[39m
  📊 Analysis Configuration:
    • Confidence threshold: 70.0%
    • Max files: unlimited
    • Coverage max age: 7 days
    • Coverage patterns: 26 patterns
    • Clone detection: denoising enabled (similarity: 82%)
[1m[94m📂 Validating Input Paths[39m[0m

  📁 Directory: [32m./src[39m

[1m📁 Output directory:[0m [36m./test-output2[39m
[1m📊 Report format:[0m [36mJSON[39m

[1m[94m📋 Coverage File Discovery Preview[39m[0m
  [32m✅[39m Found 1 coverage files:
    1. ./coverage.lcov (format: Lcov, size: 696 KB)

[1m[94m🔍 Starting Comprehensive Analysis Pipeline[39m[0m
  Enabled Analyses:
    ✅ Complexity Analysis - Cyclomatic and cognitive complexity scoring
    ✅ Structure Analysis - Directory organization and architectural patterns
    ✅ Refactoring Analysis - Refactoring opportunity detection
    ✅ Impact Analysis - Dependency graphs, cycles, and centrality
    ✅ Clone Detection - LSH-based similarity analysis (with denoising)
    ✅ Coverage Analysis - Test gap analysis
  📊 Total: 6 analyses enabled

[2m2025-09-14T02:01:59.389569Z[0m [32m INFO[0m Initializing Valknut analysis engine
[2m2025-09-14T02:01:59.389606Z[0m [32m INFO[0m WeightedShingleAnalyzer enabled for clone denoising with k=3
[2m2025-09-14T02:01:59.389608Z[0m [32m INFO[0m LSH extractor configured with denoising enabled (k=3)
[2m2025-09-14T02:01:59.389748Z[0m [32m INFO[0m Valknut engine initialized successfully
[2m2025-09-14T02:01:59.389912Z[0m [32m INFO[0m Starting directory analysis: ./src
🔍 ENGINE DEBUG: Calling pipeline.analyze_directory
[2m2025-09-14T02:01:59.389941Z[0m [32m INFO[0m Starting comprehensive analysis c8c373a3-1f70-427c-85a7-51a7765541a4 for 1 paths
[2m2025-09-14T02:01:59.400977Z[0m [32m INFO[0m Discovered 61 files for analysis
[2m2025-09-14T02:01:59.574700Z[0m [32m INFO[0m Analyzing complexity for file: ./src/api/engine.rs
[2m2025-09-14T02:01:59.585567Z[0m [32m INFO[0m Analyzing complexity for file: ./src/api/config_types.rs
[2m2025-09-14T02:01:59.592052Z[0m [32m INFO[0m Analyzing complexity for file: ./src/api/results.rs
[2m2025-09-14T02:01:59.633431Z[0m [32m INFO[0m Analyzing complexity for file: ./src/bin/cli/mod.rs
[2m2025-09-14T02:01:59.637346Z[0m [32m INFO[0m Analyzing complexity for file: ./src/bin/cli/output.rs
[2m2025-09-14T02:01:59.669537Z[0m [32m INFO[0m Analyzing complexity for file: ./src/bin/cli/args.rs
[2m2025-09-14T02:01:59.673144Z[0m [32m INFO[0m Analyzing complexity for file: ./src/bin/cli/commands.rs
[2m2025-09-14T02:01:59.717869Z[0m [32m INFO[0m Analyzing complexity for file: ./src/bin/mcp/mod.rs
[2m2025-09-14T02:01:59.721818Z[0m [32m INFO[0m Analyzing complexity for file: ./src/bin/mcp/protocol.rs
[2m2025-09-14T02:01:59.725445Z[0m [32m INFO[0m Analyzing complexity for file: ./src/bin/mcp/server.rs
[2m2025-09-14T02:01:59.730626Z[0m [32m INFO[0m Analyzing complexity for file: ./src/bin/mcp/tools.rs
[2m2025-09-14T02:01:59.740709Z[0m [32m INFO[0m Analyzing complexity for file: ./src/bin/valknut.rs
[2m2025-09-14T02:01:59.762109Z[0m [32m INFO[0m Analyzing complexity for file: ./src/core/pipeline/pipeline_results.rs
[2m2025-09-14T02:01:59.772355Z[0m [32m INFO[0m Analyzing complexity for file: ./src/core/pipeline/pipeline_config.rs
[2m2025-09-14T02:01:59.778888Z[0m [32m INFO[0m Analyzing complexity for file: ./src/core/pipeline/pipeline_executor.rs
[2m2025-09-14T02:01:59.792864Z[0m [32m INFO[0m Analyzing complexity for file: ./src/core/pipeline/mod.rs
[2m2025-09-14T02:01:59.797814Z[0m [32m INFO[0m Analyzing complexity for file: ./src/core/pipeline/pipeline_stages.rs
[2m2025-09-14T02:01:59.807954Z[0m [32m INFO[0m Analyzing complexity for file: ./src/core/errors.rs
[2m2025-09-14T02:01:59.827157Z[0m [32m INFO[0m Analyzing complexity for file: ./src/core/featureset.rs
[2m2025-09-14T02:01:59.839641Z[0m [32m INFO[0m Analyzing complexity for file: ./src/core/bayesian.rs
[2m2025-09-14T02:01:59.854584Z[0m [32m INFO[0m Analyzing complexity for file: ./src/core/config.rs
[2m2025-09-14T02:01:59.871596Z[0m [32m INFO[0m Analyzing complexity for file: ./src/core/scoring.rs
[2m2025-09-14T02:01:59.891590Z[0m [32m INFO[0m Analyzing complexity for file: ./src/core/file_utils.rs
[2m2025-09-14T02:01:59.914280Z[0m [32m INFO[0m Analyzing complexity for file: ./src/detectors/graph.rs
[2m2025-09-14T02:01:59.922609Z[0m [32m INFO[0m Analyzing complexity for file: ./src/detectors/structure/config.rs
[2m2025-09-14T02:01:59.924868Z[0m [32m INFO[0m Analyzing complexity for file: ./src/detectors/structure/mod.rs
[2m2025-09-14T02:01:59.929020Z[0m [32m INFO[0m Analyzing complexity for file: ./src/detectors/structure/directory.rs
[2m2025-09-14T02:01:59.962072Z[0m [32m INFO[0m Analyzing complexity for file: ./src/detectors/structure/file.rs
[2m2025-09-14T02:01:59.997392Z[0m [32m INFO[0m Analyzing complexity for file: ./src/detectors/refactoring.rs
[2m2025-09-14T02:02:00.012535Z[0m [32m INFO[0m Analyzing complexity for file: ./src/detectors/coverage.rs
[2m2025-09-14T02:02:00.062859Z[0m [32m INFO[0m Analyzing complexity for file: ./src/detectors/mod.rs
[2m2025-09-14T02:02:00.065210Z[0m [32m INFO[0m Analyzing complexity for file: ./src/detectors/complexity.rs
[2m2025-09-14T02:02:00.096703Z[0m [32m INFO[0m Analyzing complexity for file: ./src/detectors/names_simple.rs
[2m2025-09-14T02:02:00.114035Z[0m [32m INFO[0m Analyzing complexity for file: ./src/detectors/boilerplate_learning.rs
[2m2025-09-14T02:02:00.127265Z[0m [32m INFO[0m Analyzing complexity for file: ./src/detectors/clone_detection.rs
[2m2025-09-14T02:02:00.189822Z[0m [32m INFO[0m Analyzing complexity for file: ./src/detectors/lsh/lsh_cache.rs
[2m2025-09-14T02:02:00.204784Z[0m [32m INFO[0m Analyzing complexity for file: ./src/detectors/lsh/memory_pool.rs
[2m2025-09-14T02:02:00.212577Z[0m [32m INFO[0m Analyzing complexity for file: ./src/detectors/lsh/mod.rs
[2m2025-09-14T02:02:00.244999Z[0m [32m INFO[0m Analyzing complexity for file: ./src/io/mod.rs
[2m2025-09-14T02:02:00.245341Z[0m [32m INFO[0m Analyzing complexity for file: ./src/io/persistence.rs
[2m2025-09-14T02:02:00.245871Z[0m [32m INFO[0m Analyzing complexity for file: ./src/io/cache.rs
[2m2025-09-14T02:02:00.280864Z[0m [32m INFO[0m Analyzing complexity for file: ./src/io/reports.rs
[2m2025-09-14T02:02:00.340498Z[0m [32m INFO[0m Analyzing complexity for file: ./src/lang/go.rs
[2m2025-09-14T02:02:00.349356Z[0m [32m INFO[0m Analyzing complexity for file: ./src/lang/javascript.rs
[2m2025-09-14T02:02:00.358113Z[0m [32m INFO[0m Analyzing complexity for file: ./src/lang/typescript.rs
[2m2025-09-14T02:02:00.365974Z[0m [32m INFO[0m Analyzing complexity for file: ./src/lang/rust_lang.rs
[2m2025-09-14T02:02:00.374642Z[0m [32m INFO[0m Analyzing complexity for file: ./src/lang/common.rs
[2m2025-09-14T02:02:00.379421Z[0m [32m INFO[0m Analyzing complexity for file: ./src/lang/mod.rs
[2m2025-09-14T02:02:00.380007Z[0m [32m INFO[0m Analyzing complexity for file: ./src/lang/python.rs
[2m2025-09-14T02:02:00.406300Z[0m [32m INFO[0m Analyzing complexity for file: ./src/live/scoring.rs
[2m2025-09-14T02:02:00.418466Z[0m [32m INFO[0m Analyzing complexity for file: ./src/live/types.rs
[2m2025-09-14T02:02:00.427618Z[0m [32m INFO[0m Analyzing complexity for file: ./src/live/storage.rs
[2m2025-09-14T02:02:00.441470Z[0m [32m INFO[0m Analyzing complexity for file: ./src/live/reports.rs
[2m2025-09-14T02:02:00.450453Z[0m [32m INFO[0m Analyzing complexity for file: ./src/live/community.rs
[2m2025-09-14T02:02:00.462310Z[0m [32m INFO[0m Analyzing complexity for file: ./src/live/collectors.rs
[2m2025-09-14T02:02:00.474557Z[0m [32m INFO[0m Analyzing complexity for file: ./src/live/graph.rs
[2m2025-09-14T02:02:00.524417Z[0m [32m INFO[0m Analyzing complexity for file: ./src/live/stacks.rs
[2m2025-09-14T02:02:00.525363Z[0m [32m INFO[0m Analyzing complexity for file: ./src/live/mod.rs
[2m2025-09-14T02:02:00.526935Z[0m [32m INFO[0m Analyzing complexity for file: ./src/live/cli.rs
[2m2025-09-14T02:02:00.546656Z[0m [32m INFO[0m Analyzing complexity for file: ./src/oracle/mod.rs
[2m2025-09-14T02:02:00.567753Z[0m [32m INFO[0m Analyzing complexity for file: ./src/lib.rs
[2m2025-09-14T02:02:00.568989Z[0m [32m INFO[0m Running refactoring analysis on 61 files
Found potential duplicate line 241: 'if trimmed.contains("this appears multiple times") {'
Found potential duplicate line 608: 'let duplicate_line = "this appears multiple times";'
Found potential duplicate line 612: 'let duplicate_line2 = "this appears multiple times";'
Found potential duplicate line 616: 'let duplicate_line3 = "this appears multiple times";'
[2m2025-09-14T02:02:00.626285Z[0m [32m INFO[0m Refactoring analysis found 49 files with opportunities
[2m2025-09-14T02:02:00.644935Z[0m [32m INFO[0m Computing weighted signatures for 62 entities (cache miss)
[2m2025-09-14T02:02:00.644989Z[0m [32m INFO[0m Building IDF table for 62 entities with k=3
[2m2025-09-14T02:02:00.827309Z[0m [32m INFO[0m grams_total: 72353, grams_top1pct_pctcontrib: 7.1%
[2m2025-09-14T02:02:01.057125Z[0m [32m INFO[0m Computed weighted signatures for 61 entities
[2m2025-09-14T02:02:01.276918Z[0m [32m INFO[0m Using coverage file: ./coverage.lcov (format: Lcov)
[2m2025-09-14T02:02:01.277655Z[0m [32m INFO[0m Comprehensive analysis completed in 1.89s
[2m2025-09-14T02:02:01.277860Z[0m [32m INFO[0m Total issues found: 366
[2m2025-09-14T02:02:01.277987Z[0m [32m INFO[0m Overall health score: 75.7
🔍 ENGINE DEBUG: Pipeline returned 1761 scoring files
DEBUG: SRC calculation - entities: 3, refactoring: 0, avg_score: 0
DEBUG: DirectoryHealthTree has 14 directories
DEBUG: Directory "src/io" has health 29.9%, children: []
DEBUG: Directory "src/core" has health 44.0%, children: ["src/core/pipeline"]
DEBUG: Directory "src/live" has health 38.0%, children: []
DEBUG: Directory "src/oracle" has health 5.5%, children: []
DEBUG: Directory "src/core/pipeline" has health 24.6%, children: []
DEBUG: Directory "src/bin/cli" has health 29.4%, children: []
DEBUG: Directory "src/bin/mcp" has health 0.7%, children: []
DEBUG: Directory "src/detectors" has health 23.7%, children: ["src/detectors/lsh", "src/detectors/structure"]
DEBUG: Directory "src/lang" has health 25.0%, children: []
DEBUG: Directory "src/bin" has health 53.3%, children: ["src/bin/cli", "src/bin/mcp"]
DEBUG: Directory "src/api" has health 39.2%, children: []
DEBUG: Directory "src" has health 100.0%, children: ["src/api", "src/bin", "src/core", "src/detectors", "src/io", "src/lang", "src/live", "src/oracle"]
DEBUG: Directory "src/detectors/lsh" has health 26.4%, children: []
DEBUG: Directory "src/detectors/structure" has health 28.3%, children: []
DEBUG: Coverage enabled: true, files used: 1
DEBUG: Generated 1 coverage packs
[2m2025-09-14T02:02:01.290976Z[0m [32m INFO[0m Directory analysis completed: 61 files processed, 1761 entities analyzed
[1m[94m📊 Analysis Results[39m[0m

  ✅ Analysis completed successfully

[1m[94m🧠 Running AI Refactoring Oracle Analysis...[39m[0m
  🔍 Analyzing project: [36m./src[39m
  🧠 Sending to Gemini 2.5 Pro for intelligent refactoring suggestions...

🔍 [ORACLE DEBUG] Starting codebase bundle creation
   📁 Project path: ./src
   📊 Token budget: 400000 tokens
   📋 Found 61 candidate source files
   ✅ Included: core/pipeline/mod.rs (1551 tokens, priority: 7.50)
   ✅ Included: bin/cli/mod.rs (111 tokens, priority: 7.20)
   ✅ Included: bin/mcp/mod.rs (88 tokens, priority: 7.20)
   ✅ Included: detectors/mod.rs (90 tokens, priority: 7.20)
   ✅ Included: io/mod.rs (24 tokens, priority: 7.20)
   ✅ Included: lang/mod.rs (84 tokens, priority: 7.20)
   ✅ Included: core/pipeline/pipeline_config.rs (1711 tokens, priority: 6.50)
   ✅ Included: detectors/structure/mod.rs (2717 tokens, priority: 6.00)
   ✅ Included: live/mod.rs (1417 tokens, priority: 6.00)
   ✅ Included: lib.rs (1403 tokens, priority: 6.00)
   ✅ Included: api/config_types.rs (3621 tokens, priority: 5.00)
   ✅ Included: detectors/structure/config.rs (2196 tokens, priority: 5.00)
   ✅ Included: api/engine.rs (6001 tokens, priority: 4.55)
   ✅ Included: core/errors.rs (5289 tokens, priority: 4.55)
   ✅ Included: core/config.rs (11485 tokens, priority: 4.55)
   ✅ Included: core/pipeline/pipeline_results.rs (2538 tokens, priority: 4.50)
   ✅ Included: core/pipeline/pipeline_stages.rs (4623 tokens, priority: 4.50)
   ✅ Included: core/file_utils.rs (4645 tokens, priority: 4.50)
   ✅ Included: oracle/mod.rs (7854 tokens, priority: 4.20)
   ✅ Included: io/persistence.rs (58 tokens, priority: 3.60)
   ✅ Included: core/pipeline/pipeline_executor.rs (8062 tokens, priority: 3.15)
   ✅ Included: core/featureset.rs (7206 tokens, priority: 3.15)
   ✅ Included: core/bayesian.rs (8160 tokens, priority: 3.15)
   ✅ Included: core/scoring.rs (8300 tokens, priority: 3.15)
   ✅ Included: bin/cli/args.rs (3107 tokens, priority: 3.00)
   ✅ Included: bin/mcp/protocol.rs (1527 tokens, priority: 3.00)
   ✅ Included: bin/mcp/server.rs (3153 tokens, priority: 3.00)
   ✅ Included: bin/valknut.rs (2861 tokens, priority: 3.00)
   ✅ Included: detectors/graph.rs (3623 tokens, priority: 3.00)
   ✅ Included: detectors/lsh/lsh_cache.rs (3233 tokens, priority: 3.00)
   ✅ Included: detectors/lsh/memory_pool.rs (2767 tokens, priority: 3.00)
   ✅ Included: detectors/lsh/mod.rs (15941 tokens, priority: 3.00)
   ✅ Included: lang/javascript.rs (4063 tokens, priority: 3.00)
   ✅ Included: lang/common.rs (3446 tokens, priority: 3.00)
   ✅ Included: live/types.rs (4497 tokens, priority: 3.00)
   ✅ Included: live/stacks.rs (723 tokens, priority: 3.00)
   ✅ Included: api/results.rs (23549 tokens, priority: 2.50)
   ✅ Included: bin/mcp/tools.rs (6175 tokens, priority: 2.10)
   ✅ Included: detectors/refactoring.rs (6926 tokens, priority: 2.10)
   ✅ Included: detectors/names_simple.rs (9944 tokens, priority: 2.10)
   ✅ Included: detectors/boilerplate_learning.rs (7146 tokens, priority: 2.10)
   ✅ Included: lang/go.rs (5966 tokens, priority: 2.10)
   ✅ Included: lang/typescript.rs (5358 tokens, priority: 2.10)
   ✅ Included: lang/rust_lang.rs (6885 tokens, priority: 2.10)
   ✅ Included: lang/python.rs (6507 tokens, priority: 2.10)
   ✅ Included: live/scoring.rs (5124 tokens, priority: 2.10)
   ✅ Included: live/storage.rs (5473 tokens, priority: 2.10)
   ✅ Included: live/reports.rs (5437 tokens, priority: 2.10)
   ✅ Included: live/community.rs (7102 tokens, priority: 2.10)
   ✅ Included: live/collectors.rs (7240 tokens, priority: 2.10)
   ✅ Included: live/graph.rs (8284 tokens, priority: 2.10)
   ✅ Included: live/cli.rs (7839 tokens, priority: 2.10)
   ✅ Included: bin/cli/output.rs (18811 tokens, priority: 1.50)
   ✅ Included: bin/cli/commands.rs (21644 tokens, priority: 1.50)
   ✅ Included: detectors/structure/directory.rs (18227 tokens, priority: 1.50)
   ✅ Included: detectors/structure/file.rs (16078 tokens, priority: 1.50)
   ✅ Included: detectors/coverage.rs (23562 tokens, priority: 1.50)
   ✅ Included: detectors/complexity.rs (18940 tokens, priority: 1.50)
   ⏭️  Skipped: detectors/clone_detection.rs (31304 tokens) - would exceed budget
   ✅ Included: io/cache.rs (18752 tokens, priority: 1.50)
   ⏭️  Skipped: io/reports.rs (20013 tokens) - would exceed budget

🔍 [ORACLE DEBUG] Creating condensed valknut analysis
   📊 Analysis token budget: 50000 tokens
   🔄 Condensing valknut analysis with 50000 token budget
   ✅ Condensed analysis: 914 tokens (budget: 50000)

🎯 [ORACLE DEBUG] Bundle creation complete
   📦 Final bundle: ~429435 tokens
   📁 Files included: 59
   ⏭️  Files skipped: 2
[33m⚠️[39m Oracle analysis failed: Internal error: Gemini API error: {
  "error": {
    "code": 400,
    "message": "API key not valid. Please pass a valid API key.",
    "status": "INVALID_ARGUMENT",
    "details": [
      {
        "@type": "type.googleapis.com/google.rpc.ErrorInfo",
        "reason": "API_KEY_INVALID",
        "domain": "googleapis.com",
        "metadata": {
          "service": "generativelanguage.googleapis.com"
        }
      },
      {
        "@type": "type.googleapis.com/google.rpc.LocalizedMessage",
        "locale": "en-US",
        "message": "API key not valid. Please pass a valid API key."
      }
    ]
  }
}

   [2mAnalysis will continue without oracle suggestions[0m
[2m2025-09-14T02:02:02.125349Z[0m [33m WARN[0m Oracle analysis failed: Internal error: Gemini API error: {
  "error": {
    "code": 400,
    "message": "API key not valid. Please pass a valid API key.",
    "status": "INVALID_ARGUMENT",
    "details": [
      {
        "@type": "type.googleapis.com/google.rpc.ErrorInfo",
        "reason": "API_KEY_INVALID",
        "domain": "googleapis.com",
        "metadata": {
          "service": "generativelanguage.googleapis.com"
        }
      },
      {
        "@type": "type.googleapis.com/google.rpc.LocalizedMessage",
        "locale": "en-US",
        "message": "API key not valid. Please pass a valid API key."
      }
    ]
  }
}

[1m[94m📝 Generating Reports[39m[0m
  ✅ Report saved: [36m./test-output2/analysis-results.json[39m
[1m[32m🎉 Analysis completed successfully![39m[0m
