<!-- Clone & Similarity Analysis -->
<section class="clone-section accordion">
    <h2 class="accordion-heading" data-target="accordion-clone" role="button" aria-expanded="true" style="margin-bottom: 0.75rem; cursor: pointer;">
        <span class="accordion-icon" data-lucide="chevron-down" aria-hidden="true"></span>
        Clone &amp; Similarity Analysis
    </h2>
    <div id="accordion-clone" class="accordion-body" style="display: block;">
        <header class="clone-section__header">
            <p>Measures of structural duplication across the codebase.</p>
        </header>

    {{#if clone_analysis.hasData}}
    <div class="clone-metric-grid">
        <div class="clone-metric-card" style="display:flex;flex-direction:column;justify-content:flex-end;">
            <span class="clone-metric-card__label">Average Similarity</span>
            <span class="clone-metric-card__value">
                {{#if clone_analysis.avgSimilarity}}
                    {{format clone_analysis.avgSimilarity "0.2"}}
                {{else}}
                    —
                {{/if}}
            </span>
        </div>
        <div class="clone-metric-card" style="display:flex;flex-direction:column;justify-content:flex-end;">
            <span class="clone-metric-card__label">Maximum Similarity</span>
            <span class="clone-metric-card__value">
                {{#if clone_analysis.maxSimilarity}}
                    {{format clone_analysis.maxSimilarity "0.2"}}
                {{else}}
                    —
                {{/if}}
            </span>
        </div>
        <div class="clone-metric-card" style="display:flex;flex-direction:column;justify-content:flex-end;">
            <span class="clone-metric-card__label">Candidates After Denoising</span>
            <span class="clone-metric-card__value">
                {{#if clone_analysis.candidatesAfter}}
                    {{clone_analysis.candidatesAfter}}
                {{else}}
                    —
                {{/if}}
            </span>
        </div>
        <div class="clone-metric-card" style="display:flex;flex-direction:column;justify-content:flex-end;">
            <span class="clone-metric-card__label">Candidates Before Denoising</span>
            <span class="clone-metric-card__value">
                {{#if clone_analysis.candidatesBefore}}
                    {{clone_analysis.candidatesBefore}}
                {{else}}
                    —
                {{/if}}
            </span>
        </div>
        <div class="clone-metric-card" style="display:flex;flex-direction:column;justify-content:flex-end;">
            <span class="clone-metric-card__label">Quality Score</span>
            <span class="clone-metric-card__value">
                {{#if clone_analysis.qualityScore}}
                    {{format clone_analysis.qualityScore "0.2"}}
                {{else}}
                    —
                {{/if}}
            </span>
        </div>
        <div class="clone-metric-card" style="display:flex;flex-direction:column;justify-content:flex-end;">
            <span class="clone-metric-card__label">Denoising Enabled</span>
            <span class="clone-metric-card__value">
                {{#if clone_analysis.denoisingEnabled}}Yes{{else}}No{{/if}}
            </span>
        </div>
    </div>

    {{#if clone_pairs.length}}
    <div class="clone-panel-block" style="margin-top: 1rem; border-top: 1px solid rgba(255,255,255,0.026); border-bottom: 1px solid rgba(255,255,255,0.026); padding-top: 0.35rem; padding-bottom: 0.35rem;">
        <script id="clone-pairs-data" type="application/json">{{{json clone_pairs}}}</script>
        <div id="clone-pairs-root" aria-label="Clone pairs cards" style="min-height: 120px;"></div>
        <script>
          (function() {
            function mountPairs() {
              if (!window.ValknutMountClonePairs) {
                if (!window.ReactTreeBundle || typeof window.ReactTreeBundle.mountClonePairs !== 'function') {
                  try {
                    {{inline_js "react-tree-bundle.js"}}
                  } catch (bundleErr) {
                    console.error('[Valknut] inline bundle exec failed for clone pairs', bundleErr);
                    return;
                  }
                }
              }
              var el = document.getElementById('clone-pairs-root');
              var dataEl = document.getElementById('clone-pairs-data');
              if (!el || !dataEl) return;
              try {
                var pairs = JSON.parse(dataEl.textContent || '[]') || [];
                if (typeof window.ValknutMountClonePairs === 'function') {
                  window.ValknutMountClonePairs(pairs, 'clone-pairs-root');
                } else {
                  window.ReactTreeBundle.mountClonePairs(pairs, 'clone-pairs-root');
                }
              } catch (err) {
                console.error('[Valknut] clone pairs mount failed', err);
              }
            }
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
              mountPairs();
            } else {
              document.addEventListener('DOMContentLoaded', mountPairs);
            }
          })();
        </script>
    </div>
    {{/if}}

    {{else}}
    <div class="clone-empty">
        Clone detection was not enabled for this report run.
    </div>
    {{/if}}
    </div>
</section>
