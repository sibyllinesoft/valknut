<!-- Code Analysis Tree -->
<div class="results-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 style="margin: 0;">Code Analysis Tree</h2>
        <div class="filter-dropdown" style="position: relative;">
            <button id="filter-button" onclick="toggleFilterMenu()" style="display: flex; align-items: center; gap: 0.5rem; background: transparent; border: 1px solid var(--keyline); padding: 0.5rem 0.75rem; border-radius: var(--radius); cursor: pointer; color: var(--text); font-size: 0.875rem;">
                <i data-lucide="filter" style="width: 16px; height: 16px;"></i>
                Filter
                <i data-lucide="chevron-down" style="width: 14px; height: 14px;"></i>
            </button>
            <div id="filter-menu" class="filter-menu" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 0.25rem; background: rgba(42, 42, 42, 0.85); backdrop-filter: blur(15px); border: 1px solid var(--keyline); border-radius: 12px; box-shadow: 0 12px 48px rgba(0,0,0,0.3); min-width: 320px; z-index: 10; padding: 1rem;">
                <div style="padding: 0.75rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 0.75rem;">
                        <input type="checkbox" id="filter-high-complexity" onchange="applyFilters()" checked>
                        <span style="font-weight: 500;">High Complexity Only</span>
                    </label>
                    <div style="height: 1px; background: var(--keyline); margin: 0.5rem 0;"></div>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 0.5rem;">
                        <input type="checkbox" id="filter-extract-method" onchange="applyFilters()" checked>
                        <span>Extract Method</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 0.5rem;">
                        <input type="checkbox" id="filter-simplify-conditionals" onchange="applyFilters()" checked>
                        <span>Simplify Conditionals</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 0.5rem;">
                        <input type="checkbox" id="filter-improve-structure" onchange="applyFilters()" checked>
                        <span>Improve Structure</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="filter-general-refactoring" onchange="applyFilters()" checked>
                        <span>General Refactoring</span>
                    </label>
                </div>
            </div>
        </div>
    </div>
    <!-- React Arborist Tree Container -->
    <div id="react-tree-root" class="analysis-tree" style="height: 600px;">
        <!-- Tree will be mounted here by React -->
    </div>
    
    <!-- Data for React tree (embedded JSON) -->
    <script id="tree-data" type="application/json">
        {
            "refactoringCandidatesByFile": [
                {{#each refactoring_candidates_by_file}}
                {
                    "fileName": "{{file_name}}",
                    "filePath": "{{file_path}}",
                    "highestPriority": "{{highest_priority}}",
                    "entityCount": {{entity_count}},
                    "avgScore": {{avg_score}},
                    "totalIssues": {{total_issues}},
                    "entities": [
                        {{#each entities}}
                        {
                            "name": "{{{name}}}",
                            "priority": "{{priority}}",
                            "score": {{#if score}}{{score}}{{else}}0{{/if}},
                            "lineRange": {{#if line_range}}[{{line_range.0}}, {{line_range.1}}]{{else}}null{{/if}},
                            "issueCount": {{#if issue_count}}{{issue_count}}{{else}}0{{/if}},
                            "suggestionCount": {{#if suggestion_count}}{{suggestion_count}}{{else}}0{{/if}},
                            "issueCategories": "{{#each issues}}{{category}}{{#unless @last}}, {{/unless}}{{/each}}",
                            "suggestionTypes": "{{#each suggestions}}{{type}}{{#unless @last}}, {{/unless}}{{/each}}"
                        }{{#unless @last}},{{/unless}}
                        {{/each}}
                    ]
                }{{#unless @last}},{{/unless}}
                {{/each}}
            ],
            "directoryHealthTree": {{#if directory_health_tree}}{{{json directory_health_tree}}}{{else}}null{{/if}}
        }
    </script>
    
    
    <!-- Self-contained React bundle with all dependencies -->
    <script src="./react-tree-bundle.debug.js"></script>
    
    <!-- Mount React Tree Component -->
    <script>
        // Mount the React component
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ DOM loaded, attempting to mount React tree...');
            
            const container = document.getElementById('react-tree-root');
            console.log('üì¶ Container found:', !!container);
            console.log('‚öõÔ∏è React available:', typeof window.React !== 'undefined');
            console.log('üîó ReactDOM available:', typeof window.ReactDOM !== 'undefined');
            console.log('üå≥ ReactTreeBundle available:', typeof window.ReactTreeBundle !== 'undefined');
            console.log('üå≥ CodeAnalysisTree fallback available:', typeof window.CodeAnalysisTree !== 'undefined');
            
            if (!container) {
                console.error('‚ùå Container #react-tree-root not found');
                return;
            }
            
            if (typeof window.React === 'undefined') {
                console.error('‚ùå React not loaded');
                container.innerHTML = '<div style="color: #ff6b6b; padding: 20px; text-align: center;">‚ùå React not loaded</div>';
                return;
            }
            
            if (typeof window.ReactDOM === 'undefined') {
                console.error('‚ùå ReactDOM not loaded');
                container.innerHTML = '<div style="color: #ff6b6b; padding: 20px; text-align: center;">‚ùå ReactDOM not loaded</div>';
                return;
            }
            
            // Check for webpack library export first, then fallback
            const TreeComponent = window.ReactTreeBundle || window.CodeAnalysisTree;
            if (!TreeComponent) {
                console.error('‚ùå Tree component not loaded (checked ReactTreeBundle and CodeAnalysisTree)');
                container.innerHTML = '<div style="color: #ff6b6b; padding: 20px; text-align: center;">‚ùå Tree component not loaded</div>';
                return;
            }
            
            try {
                // Parse the embedded tree data
                const treeDataScript = document.getElementById('tree-data');
                let analysisData = null;
                
                if (treeDataScript) {
                    const rawData = treeDataScript.textContent.trim();
                    console.log('üìÑ Raw JSON length:', rawData.length);
                    
                    try {
                        analysisData = JSON.parse(rawData);
                        console.log('üìä Parsed analysis data successfully:', {
                            refactoringFiles: analysisData?.refactoringCandidatesByFile?.length || 0,
                            hasDirectoryHealth: !!analysisData?.directoryHealthTree
                        });
                    } catch (jsonError) {
                        console.error('‚ùå JSON parse error:', jsonError);
                        console.error('üìÑ Raw data sample:', rawData.substring(0, 200) + '...');
                        container.innerHTML = '<div style="color: #ff6b6b; padding: 20px; text-align: center;">‚ùå Invalid JSON data: ' + jsonError.message + '</div>';
                        return;
                    }
                } else {
                    console.warn('‚ö†Ô∏è No tree-data script element found');
                    analysisData = { refactoringCandidatesByFile: [], directoryHealthTree: null };
                }
                
                // Mount React component with parsed data
                const { createRoot } = ReactDOM;
                const root = createRoot(container);
                root.render(React.createElement(TreeComponent, {
                    data: analysisData
                }));
                
                console.log('‚úÖ React component mounted successfully');
                
                // Initialize Lucide icons after React renders
                setTimeout(() => {
                    if (window.lucide) {
                        window.lucide.createIcons();
                        console.log('üé® Lucide icons initialized');
                    }
                }, 100);
                
            } catch (error) {
                console.error('‚ùå Failed to mount React tree:', error);
                container.innerHTML = '<div style="color: #ff6b6b; padding: 20px; text-align: center;">‚ùå Failed to mount: ' + error.message + '</div>';
            }
        });
    </script>
</div>