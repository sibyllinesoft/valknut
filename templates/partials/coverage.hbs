<!-- Coverage Analysis -->
{{#if results.coverage_packs}}
<section class="coverage-section tab-panel" data-tab="coverage">
    <div class="tab-heading-row" style="display:none;">
        <h2 class="tab-heading">Coverage</h2>
    </div>
    <div class="tab-body coverage-tab-body">
        <div class="analysis-tree" id="coverage-tree">
            {{#each results.coverage_packs}}
            <div class="tree-node" data-level="0">
                <div class="tree-header tree-expandable"
                     role="button"
                     tabindex="0"
                     aria-expanded="false"
                     onclick="toggleCoverageNode(this)"
                     onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleCoverageNode(this);}">
                    <div class="tree-chevron">
                        <svg class="chevron-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="tree-icon"><i data-lucide="file-code"></i></div>
                    <div class="tree-label" data-path="{{path}}">{{path}}</div>
                    <div class="tree-badge tree-badge-Medium">
                        {{length gaps}} gaps
                    </div>
                    <div class="tree-badge tree-badge-low">
                        Coverage: {{percentage file_info.coverage_before "1"}}%
                    </div>
                </div>
                <div class="tree-children collapsed" style="display:none; margin-left: 1rem; margin-right: 1rem;">
                    <!-- File Info -->
                    <div class="tree-leaf" style="margin-left: 1.5rem; margin-right: 0; border-radius: 8px;">
                        <div class="tree-leaf-value">
                            <div style="display:flex; flex-wrap:wrap; justify-content:space-around; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <div class="stat-item" style="min-width:140px; text-align:center;">
                                    <div class="stat-label">Lines of Code</div>
                                    <div class="stat-value">{{file_info.loc}}</div>
                                </div>
                                <div class="stat-item" style="min-width:140px; text-align:center;">
                                    <div class="stat-label">Current Coverage</div>
                                    <div class="stat-value">{{percentage file_info.coverage_before "1"}}%</div>
                                </div>
                                <div class="stat-item" style="min-width:140px; text-align:center;">
                                    <div class="stat-label">Tests to Write</div>
                                    <div class="stat-value">{{effort.tests_to_write_est}}</div>
                                </div>
                                <div class="stat-item" style="min-width:140px; text-align:center;">
                                    <div class="stat-label">Repo Impact</div>
                                    <div class="stat-value">+{{percentage value.repo_cov_gain_est "2"}}%</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Coverage Gaps -->
                    {{#each gaps}}
                    <div class="tree-leaf" style="margin-left: 1.5rem; margin-right: 0; border-radius: 8px;">
                        <div class="tree-leaf-header">
                            <div class="tree-leaf-title">
                                {{#if ../path}}
                                <a href="vscode://file{{../path}}:{{span.start}}" style="color:inherit; text-decoration:none;" onclick="event.stopPropagation();">Coverage Gap (Lines {{span.start}}-{{span.end}})</a>
                                {{else}}
                                Coverage Gap (Lines {{span.start}}-{{span.end}})
                                {{/if}}
                            </div>
                            <div class="tree-badge tree-badge-{{#if (gt score 0.8)}}High{{else}}{{#if (gt score 0.6)}}Medium{{else}}Low{{/if}}{{/if}}">
                                Score: {{format score "0.2"}}
                            </div>
                        </div>
                        <div class="tree-leaf-value">
                            <!-- Code Preview -->
                            {{#if symbols}}
                            <div style="margin-bottom: 0.5rem;">
                                {{#each symbols}}
                                <div style="background: rgba(255,255,255,0.035); padding: 0.25rem 0.5rem; margin-bottom: 0.25rem; border-radius: 3px; font-family: var(--font-mono); font-size: 0.75rem;">
                                    <div style="color: var(--accent); margin-bottom: 0.125rem;">{{kind}}: {{name}}</div>
                                    <div style="color: var(--muted);">{{signature}}</div>
                                </div>
                                {{/each}}
                            </div>
                            {{/if}}

                            <!-- Code Snippet -->
                            {{#if preview}}
                            <div style="background: transparent; border-left: 3px solid var(--accent);">
                                <pre style="margin:0; white-space: pre-wrap; word-break: break-word;"><code class="language-{{preview.language}}" data-preview-id="code-preview-{{@../index}}-{{@index}}"></code></pre>
                                <script type="application/json" id="code-preview-{{@../index}}-{{@index}}">{{{json preview}}}</script>
                            </div>
                            {{/if}}
                        </div>
                    </div>
                    {{/each}}
                </div>
            </div>
            {{/each}}
        </div>
    </div>
</section>
{{/if}}

{{!-- Coverage interactions --}}
<script>
(function() {
    // Toggle handler (used by inline attributes and scripted wiring)
    window.toggleCoverageNode = function(el) {
        const header = el.closest('.tree-header');
        const node = header?.closest('.tree-node');
        const children = node?.querySelector('.tree-children');
        const chevron = header?.querySelector('.chevron-icon');
        if (!node || !children) return;
        const next = node.getAttribute('aria-expanded') !== 'true';
        node.setAttribute('aria-expanded', String(next));
        children.classList.toggle('collapsed', !next);
        children.classList.toggle('expanded', next);
        children.style.display = next ? 'block' : 'none';
        if (chevron) chevron.style.transform = next ? 'rotate(90deg)' : 'rotate(0deg)';
    };

    // Wire click handlers in case inline handlers are stripped
    function wireCoverageToggles() {
        const headers = document.querySelectorAll('.coverage-section .tree-header');
        headers.forEach((header) => {
            header.addEventListener('click', () => toggleCoverageNode(header));
            header.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleCoverageNode(header);
                }
            });
        });
    }

    // Shorten coverage paths to project-relative (no basename fallback)
    function shortenCoveragePaths() {
        const projectRoot = {{#if project_root}}{{{json project_root}}}{{else}}""{{/if}};
        const normRoot = projectRoot ? projectRoot.replace(/\\/g, '/').replace(/\/+$/, '') : '';
        const labels = Array.from(document.querySelectorAll('.coverage-section .tree-label'));
        labels.forEach((labelEl) => {
            const raw = (labelEl.getAttribute('data-path') || labelEl.textContent || '').trim();
            if (!raw) return;
            let display = raw.replace(/\\/g, '/');
            if (normRoot && display.startsWith(normRoot)) {
                display = display.slice(normRoot.length);
            }
            display = display.replace(/^[/\\]+/, '');
            labelEl.textContent = display;
            labelEl.setAttribute('title', raw);
        });
    }

    function initCoverageUI() {
        shortenCoveragePaths();
        wireCoverageToggles();
        if (window.lucide) window.lucide.createIcons();
        if (window.hljs) {
            document.querySelectorAll('.coverage-section pre code').forEach((block) => {
                const id = block.getAttribute('data-preview-id');
                if (id) {
                    const scriptEl = document.getElementById(id);
                    if (scriptEl) {
                        try {
                            const preview = JSON.parse(scriptEl.textContent || '{}');
                            const lines = []
                                .concat(preview.pre || [])
                                .concat(preview.head || [])
                                .concat(preview.tail || [])
                                .concat(preview.post || []);
                            block.textContent = lines.join('\n');
                        } catch (e) {
                            console.warn('Preview parse failed', e, id);
                            block.textContent = '';
                        }
                    }
                }
                block.removeAttribute('data-highlighted');
                window.hljs.highlightElement(block);
            });
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCoverageUI);
    } else {
        initCoverageUI();
    }
})();
</script>
