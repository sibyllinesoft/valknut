<!-- Coverage Analysis -->
{{#if results.coverage_packs}}
<section class="coverage-section tab-panel" data-tab="coverage">
    <div class="tab-heading-row" style="display:none;">
        <h2 class="tab-heading">Coverage</h2>
    </div>
    <div class="tab-body coverage-tab-body">
        <div class="analysis-tree" id="coverage-tree">
            {{#each results.coverage_packs}}
            <div class="tree-node" data-level="0">
                <div class="tree-header tree-expandable"
                     role="button"
                     tabindex="0"
                     aria-expanded="false"
                     onclick="toggleCoverageNode(this)"
                     onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleCoverageNode(this);}">
                    <div class="tree-chevron">
                        <svg class="chevron-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="tree-icon"><i data-lucide="file-code"></i></div>
                    <div class="tree-label">{{path}}</div>
                    <div class="tree-badge tree-badge-Medium">
                        {{length gaps}} gaps
                    </div>
                    <div class="tree-badge tree-badge-low">
                        Coverage: {{percentage file_info.coverage_before "1"}}%
                    </div>
                </div>
                <div class="tree-children collapsed" style="display:none; margin-left: 1rem; margin-right: 1rem;">
                    <!-- File Info -->
                    <div class="tree-leaf" style="margin-left: 1.5rem; margin-right: 0;">
                        <div class="tree-leaf-header">
                            <div class="tree-leaf-title">Coverage Metrics</div>
                        </div>
                        <div class="tree-leaf-value">
                            <div style="display:flex; flex-wrap:wrap; justify-content:space-around; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <div class="stat-item" style="min-width:140px; text-align:center;">
                                    <div class="stat-label" style="margin-bottom:0.2rem; color: var(--muted); text-transform:uppercase; letter-spacing:0.05em; font-size:0.7rem;">Lines of Code</div>
                                    <div class="stat-value" style="font-size:1.3rem; font-weight:700;">{{file_info.loc}}</div>
                                </div>
                                <div class="stat-item" style="min-width:140px; text-align:center;">
                                    <div class="stat-label" style="margin-bottom:0.2rem; color: var(--muted); text-transform:uppercase; letter-spacing:0.05em; font-size:0.7rem;">Current Coverage</div>
                                    <div class="stat-value" style="font-size:1.3rem; font-weight:700;">{{percentage file_info.coverage_before "1"}}%</div>
                                </div>
                                <div class="stat-item" style="min-width:140px; text-align:center;">
                                    <div class="stat-label" style="margin-bottom:0.2rem; color: var(--muted); text-transform:uppercase; letter-spacing:0.05em; font-size:0.7rem;">Tests to Write</div>
                                    <div class="stat-value" style="font-size:1.3rem; font-weight:700;">{{effort.tests_to_write_est}}</div>
                                </div>
                                <div class="stat-item" style="min-width:140px; text-align:center;">
                                    <div class="stat-label" style="margin-bottom:0.2rem; color: var(--muted); text-transform:uppercase; letter-spacing:0.05em; font-size:0.7rem;">Repo Impact</div>
                                    <div class="stat-value" style="font-size:1.3rem; font-weight:700;">+{{percentage value.repo_cov_gain_est "2"}}%</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Coverage Gaps -->
                    {{#each gaps}}
                    <div class="tree-leaf" style="margin-left: 1.5rem; margin-right: 0;">
                        <div class="tree-leaf-header">
                            <div class="tree-leaf-title">Coverage Gap (Lines {{span.start}}-{{span.end}})</div>
                            <div class="tree-badge tree-badge-{{#if (gt score 0.8)}}High{{else}}{{#if (gt score 0.6)}}Medium{{else}}Low{{/if}}{{/if}}">
                                Score: {{format score "0.2"}}
                            </div>
                        </div>
                        <div class="tree-leaf-value">
                            <!-- Code Preview -->
                            {{#if symbols}}
                            <div style="margin-bottom: 0.5rem;">
                                {{#each symbols}}
                                <div style="background: rgba(255,255,255,0.035); padding: 0.25rem 0.5rem; margin-bottom: 0.25rem; border-radius: 3px; font-family: var(--font-mono); font-size: 0.75rem;">
                                    <div style="color: var(--accent); margin-bottom: 0.125rem;">{{kind}}: {{name}}</div>
                                    <div style="color: var(--muted);">{{signature}}</div>
                                </div>
                                {{/each}}
                            </div>
                            {{/if}}

                            <!-- Code Snippet -->
                            {{#if preview}}
                            <div style="background: rgba(255,255,255,0.035); padding: 0.5rem; border-radius: 4px; border-left: 3px solid var(--accent); overflow:auto;">
                                <pre style="margin:0;"><code class="language-{{preview.language}}">
{{#if preview.pre}}{{#each preview.pre}}{{this}}
{{/each}}{{/if}}{{#if preview.head}}{{#each preview.head}}{{this}}
{{/each}}{{/if}}{{#if preview.tail}}{{#each preview.tail}}{{this}}
{{/each}}{{/if}}{{#if preview.post}}{{#each preview.post}}{{this}}
{{/each}}{{/if}}</code></pre>
                            </div>
                            {{/if}}
                        </div>
                    </div>
                    {{/each}}
                </div>
            </div>
            {{/each}}
        </div>
    </div>
</section>
{{/if}}

{{!-- Coverage interactions --}}
<script>
(function() {
    // Toggle handler (used by inline attributes and scripted wiring)
    window.toggleCoverageNode = function(el) {
        const header = el.closest('.tree-header');
        const node = header?.closest('.tree-node');
        const children = node?.querySelector('.tree-children');
        const chevron = header?.querySelector('.chevron-icon');
        if (!node || !children) return;
        const next = node.getAttribute('aria-expanded') !== 'true';
        node.setAttribute('aria-expanded', String(next));
        children.classList.toggle('collapsed', !next);
        children.classList.toggle('expanded', next);
        children.style.display = next ? 'block' : 'none';
        if (chevron) chevron.style.transform = next ? 'rotate(90deg)' : 'rotate(0deg)';
    };

    // Wire click handlers in case inline handlers are stripped
    function wireCoverageToggles() {
        const headers = document.querySelectorAll('.coverage-section .tree-header');
        headers.forEach((header) => {
            header.addEventListener('click', () => toggleCoverageNode(header));
            header.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleCoverageNode(header);
                }
            });
        });
    }

    // Shorten coverage paths to project-relative or common prefix
    function shortenCoveragePaths() {
        const projectRoot = {{#if project_root}}{{{json project_root}}}{{else}}""{{/if}};
        const normRoot = projectRoot ? projectRoot.replace(/\\/g, '/').replace(/\/+$/, '') : '';
        const labels = Array.from(document.querySelectorAll('.coverage-section .tree-label'));
        const rawPaths = labels.map((el) => String(el.textContent || '').trim().replace(/\\/g, '/')).filter(Boolean);

        // Derive a common prefix if project root is absent or mismatch
        const commonPrefix = (() => {
            if (rawPaths.length === 0) return '';
            const parts = rawPaths.map((p) => p.split('/'));
            const shortest = Math.min(...parts.map((p) => p.length));
            const prefix = [];
            for (let i = 0; i < shortest; i++) {
                const segment = parts[0][i];
                if (parts.every((p) => p[i] === segment)) {
                    prefix.push(segment);
                } else {
                    break;
                }
            }
            return prefix.join('/');
        })();

        labels.forEach((labelEl, idx) => {
            const raw = rawPaths[idx];
            if (!raw) return;
            const normalized = raw;
            let display = normalized;
            if (normRoot && normalized.startsWith(normRoot)) {
                display = normalized.slice(normRoot.length);
                if (display.startsWith('/')) display = display.slice(1);
                if (display.startsWith('\\')) display = display.slice(1);
            } else if (commonPrefix && normalized.startsWith(commonPrefix)) {
                display = normalized.slice(commonPrefix.length);
                if (display.startsWith('/')) display = display.slice(1);
                if (display.startsWith('\\')) display = display.slice(1);
            } else {
                const parts = normalized.split('/');
                display = parts[parts.length - 1] || normalized;
            }
            labelEl.textContent = display;
            labelEl.setAttribute('title', raw);
        });
    }

    function initCoverageUI() {
        shortenCoveragePaths();
        wireCoverageToggles();
        if (window.lucide) window.lucide.createIcons();
        if (window.hljs) {
            document.querySelectorAll('.coverage-section pre code').forEach((block) => {
                // Normalize to plain text to strip any unintended HTML
                const raw = block.textContent || '';
                block.textContent = raw;
                block.removeAttribute('data-highlighted');
                window.hljs.highlightElement(block);
            });
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCoverageUI);
    } else {
        initCoverageUI();
    }
})();
</script>
