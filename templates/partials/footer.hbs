    <div id="debug-modal">
        <div class="debug-backdrop"></div>
        <div class="debug-dialog">
            <div class="debug-dialog__header">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span data-lucide="database" aria-hidden="true"></span>
                    <span>Raw Analysis Data</span>
                </div>
                <button id="debug-close" aria-label="Close debug modal" style="background:none;border:none;color:inherit;cursor:pointer;">
                    <span data-lucide="x"></span>
                </button>
            </div>
            <div class="debug-dialog__body">
                <pre id="debug-json" class="json-pre">Loading…</pre>
            </div>
        </div>
    </div>

    <script id="raw-analysis-json" type="application/json">{{#if results}}{{{json results}}}{{else}}{}{{/if}}</script>
</div>

<script>
    // Filter dropdown functionality (optional - only works if filter elements exist)
    function toggleFilterMenu() {
        const menu = document.getElementById('filter-menu');
        const button = document.getElementById('filter-button');
        
        // Only proceed if filter elements exist
        if (!menu || !button) {
            console.warn('Filter menu elements not found - filter functionality unavailable');
            return;
        }
        
        const chevron = button.querySelector('[data-lucide="chevron-down"]');
        
        if (menu.style.display === 'none') {
            menu.style.display = 'block';
            if (chevron) {
                chevron.setAttribute('data-expanded', 'true');
            }
        } else {
            menu.style.display = 'none';
            if (chevron) {
                chevron.setAttribute('data-expanded', 'false');
            }
        }
    }
    
    // Close filter menu when clicking outside (only if filter elements exist)
    document.addEventListener('click', function(event) {
        const dropdown = document.querySelector('.filter-dropdown');
        const menu = document.getElementById('filter-menu');
        
        // Only proceed if filter elements actually exist
        if (dropdown && menu && !dropdown.contains(event.target)) {
            menu.style.display = 'none';
            const chevron = document.querySelector('#filter-button [data-lucide="chevron-down"]');
            if (chevron) {
                chevron.setAttribute('data-expanded', 'false');
            }
        }
    });
    
    // Apply filters based on checkboxes (optional - only works if filter elements exist)
    function applyFilters() {
        // FIXME: Temporarily disable all filtering - show everything
        return true;
        
        // Check if filter elements exist before proceeding
        const filterElements = [
            'filter-high-complexity',
            'filter-extract-method', 
            'filter-simplify-conditionals',
            'filter-improve-structure',
            'filter-general-refactoring'
        ];
        
        const hasAllFilters = filterElements.every(id => document.getElementById(id) !== null);
        if (!hasAllFilters) {
            console.warn('Filter checkboxes not found - filter functionality unavailable');
            return true; // Show everything if filters don't exist
        }
        
        const highComplexityOnly = document.getElementById('filter-high-complexity').checked;
        const extractMethod = document.getElementById('filter-extract-method').checked;
        const simplifyConditionals = document.getElementById('filter-simplify-conditionals').checked;
        const improveStructure = document.getElementById('filter-improve-structure').checked;
        const generalRefactoring = document.getElementById('filter-general-refactoring').checked;
        
        const fileNodes = document.querySelectorAll('.file-node');
        
        fileNodes.forEach(fileNode => {
            let shouldShow = false;
            
            // Check if file meets complexity filter
            const priority = fileNode.getAttribute('data-priority');
            const meetsComplexityFilter = !highComplexityOnly || priority === 'Critical' || priority === 'High';
            
            if (meetsComplexityFilter) {
                // Check if file has any refactoring suggestions that match the selected types
                const suggestions = fileNode.querySelectorAll('.suggestion-item');
                if (suggestions.length === 0) {
                    // If no specific suggestions found, show the file (it might have general refactoring needs)
                    shouldShow = true;
                } else {
                    // Check each suggestion to see if it matches selected refactoring types
                    suggestions.forEach(suggestion => {
                        const suggestionText = suggestion.textContent.toLowerCase();
                        if ((extractMethod && suggestionText.includes('extract')) ||
                            (simplifyConditionals && suggestionText.includes('conditional')) ||
                            (improveStructure && suggestionText.includes('structure')) ||
                            (generalRefactoring && !suggestionText.includes('extract') && 
                             !suggestionText.includes('conditional') && !suggestionText.includes('structure'))) {
                            shouldShow = true;
                        }
                    });
                }
            }
            
            // Apply filter
            if (shouldShow) {
                fileNode.classList.remove('filtered-out');
            } else {
                fileNode.classList.add('filtered-out');
            }
        });
        
        // Log filtering results
        const visibleFiles = document.querySelectorAll('.file-node:not(.filtered-out)').length;
        const totalFiles = fileNodes.length;
        console.log(`Filter: Showing ${visibleFiles} of ${totalFiles} files`);
    }
    
    // Initialize components when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        {{#if enable_animation}}
        // Trefoil animation initializes automatically via its own DOMContentLoaded handler
        {{/if}}
        
        console.log(`Target: Valknut Analysis Report Loaded`);
        console.log(`Chart: Found ${document.querySelectorAll('.tree-node').length} refactoring candidates`);
        console.log(`Palette: Using Sibylline Design System Theme`);
        
        // Initialize Lucide icons
        lucide.createIcons();
    });
    
    // Smooth scrolling for tree navigation
    function scrollToNode(nodeId) {
        const element = document.getElementById(nodeId);
        if (element) {
            element.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        }
    }
    
    // Tab styles to match headers + debug modal styles
    document.addEventListener('DOMContentLoaded', function() {
        const styleEl = document.createElement('style');
        styleEl.textContent = `
        .tabs {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin: 0 0 0.75rem 0;
        }
        .container {
            padding-left: 2rem;
            padding-right: 2rem;
        }
        .analysis-summary.results-section {
            margin-bottom: 32px;
        }
        .clone-metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.85rem;
            margin-bottom: 1.25rem;
            width: 100%;
        }
        .tab-button {
            background: transparent;
            border: none;
            color: var(--color-text);
            padding: 0;
            margin: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font: inherit;
        }
        .tab-button:not(.tab-active) { color: rgba(229, 231, 235, 0.35); }
        .tab-button:focus { outline: none; box-shadow: none; }
        .tab-button .tab-heading {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 700;
            color: inherit;
        }
        .tab-button.tab-active { color: var(--color-text); }

        /* Debug modal */
        #debug-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        #debug-modal.open { display: flex; }
        .debug-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.45);
            backdrop-filter: blur(6px);
        }
        .debug-dialog {
            position: relative;
            background: rgba(30,30,30,0.7);
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: var(--shadow-lg);
            border-radius: 12px;
            padding: 12px;
            width: min(960px, 90vw);
            max-height: 80vh;
            backdrop-filter: blur(16px);
        }
        .debug-dialog__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--color-text);
            font-weight: 600;
            padding: 6px 4px 10px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .debug-dialog__body {
            padding: 10px 4px 6px;
        }
        .json-pre {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 8px;
            padding: 20px;
            color: var(--color-text);
            font-family: var(--font-mono);
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow: auto;
            max-height: 65vh;
        }
        /* Custom scrollbar for JSON container - hide track */
        .json-pre::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .json-pre::-webkit-scrollbar-track {
            background: transparent;
        }
        .json-pre::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }
        .json-pre::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .json-pre .key { color: #93c5fd; }
        .json-pre .string { color: #a7f3d0; }
        .json-pre .number { color: #fca5a5; }
        .json-pre .bool { color: #fcd34d; }
        .json-pre .null { color: #c084fc; }

        /* Tooltip list bullets → horizontal bars */
        .tooltip-section-list {
            list-style: none;
            margin: 0.35rem 0 0;
            padding: 0;
            display: grid;
            gap: 0.35rem;
        }
        .tooltip-section-list li {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        .tooltip-section-list li::before {
            content: '';
            display: inline-block;
            width: 16px;
            height: 3px;
            border-radius: 999px;
            background: rgba(255,255,255,0.28);
            flex-shrink: 0;
        }
        .tooltip-section-list .issue-heading,
        .tooltip-section-list .issue-summary {
            color: var(--color-text);
            font-weight: 400;
            font-size: 0.9rem;
        }
        .tooltip-name {
            text-align: center;
            width: 100%;
        }
        .valknut-tooltip hr {
            display: none !important;
        }
        .valknut-tooltip .tooltip-name {
            text-align: center;
            width: 100%;
            margin: 0 0 4px 0;
        }
        .valknut-tooltip .tooltip-section {
            margin-top: 14px;
            padding-top: 0;
            border-top: none;
        }
        .valknut-tooltip .tooltip-section h4 {
            margin: 6px 0 4px 0;
            font-weight: 600;
            font-size: 0.95rem;
        }
        .valknut-tooltip .tooltip-section-list {
            margin-top: 4px;
        }
        .valknut-tooltip .tooltip-metrics {
            list-style: none;
            padding: 0;
            margin: 0 0 6px 0;
            color: rgba(229, 231, 235, 0.78);
        }
        .valknut-tooltip .tooltip-metrics li {
            display: block;
            font-size: 0.95rem;
            line-height: 1.25;
        }
        .valknut-tooltip .tooltip-metrics .metric-label,
        .valknut-tooltip .tooltip-metrics .metric-value {
            display: inline;
            line-height: inherit;
        }
        .valknut-tooltip .tooltip-metrics .metric-label::after {
            content: ': ';
        }
        `;
        document.head.appendChild(styleEl);
        lucide.createIcons();
    });

    // Simple tabs (replace accordion behavior)
    function initTabs() {
        const panels = Array.from(document.querySelectorAll('.tab-panel'));
        if (!panels.length) return;

        const tabsContainer = document.createElement('div');
        tabsContainer.className = 'tabs';

        const tabButtons = panels.map((panel, idx) => {
            const id = panel.getAttribute('data-tab') || `tab-${idx}`;
            panel.setAttribute('data-tab', id);
            const heading = panel.querySelector('.tab-heading');

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'tab-button';
            btn.dataset.tabTarget = id;

            // Render the original heading element inside the button for matching style
            const btnHeading = document.createElement('h2');
            btnHeading.className = 'tab-heading';
            btnHeading.textContent = heading ? heading.textContent.trim() : `Tab ${idx + 1}`;
            btn.appendChild(btnHeading);

            tabsContainer.appendChild(btn);
            return { btn, panel, heading };
        });

        // Insert tabs container ahead of the first panel
        panels[0].parentNode.insertBefore(tabsContainer, panels[0]);

        function activate(id) {
            tabButtons.forEach(({ btn, panel }) => {
                const active = panel.getAttribute('data-tab') === id;
                panel.classList.toggle('tab-active', active);
                panel.style.display = active ? 'block' : 'none';
                btn.classList.toggle('tab-active', active);
            });
            window.dispatchEvent(new CustomEvent('valknut-tab-activated', { detail: { id } }));
        }

        const defaultId = panels[0].getAttribute('data-tab');
        activate(defaultId);

        tabButtons.forEach(({ btn }) => {
            btn.addEventListener('click', () => activate(btn.dataset.tabTarget));
        });
    }

    // Oracle phase toggle functionality
    function togglePhase(element) {
        const phaseCard = element.closest('.phase-card');
        const phaseContent = phaseCard.querySelector('.phase-content');
        const chevron = element.querySelector('[data-lucide="chevron-right"]');
        
        if (phaseContent.style.display === 'none') {
            phaseContent.style.display = 'block';
            chevron.setAttribute('data-expanded', 'true');
        } else {
            phaseContent.style.display = 'none';
            chevron.setAttribute('data-expanded', 'false');
        }
    }

    document.addEventListener('DOMContentLoaded', initTabs);

    // Helper function to capitalize strings (for Handlebars templates that might need it)
    function capitalize(str) {
        if (!str) return '';
        return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
    }

    // Debug modal wiring
    (function setupDebugModal() {
        const debugBtn = document.getElementById('debug-open');
        const debugModal = document.getElementById('debug-modal');
        const debugClose = document.getElementById('debug-close');
        const debugJsonEl = document.getElementById('debug-json');
        const rawDataEl = document.getElementById('raw-analysis-json');

        function highlight(jsonText) {
            return jsonText
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"(\w+)":/g, '"<span class="key">$1</span>":')
                .replace(/: "(.*?)"/g, ': "<span class="string">$1</span>"')
                .replace(/: (\d+\.\d+|\d+)/g, ': <span class="number">$1</span>')
                .replace(/: (true|false)/g, ': <span class="bool">$1</span>')
                .replace(/: null/g, ': <span class="null">null</span>');
        }

        function openDebug() {
            if (!debugModal) return;
            if (rawDataEl && debugJsonEl) {
                try {
                    const parsed = JSON.parse(rawDataEl.textContent || '{}');
                    const pretty = JSON.stringify(parsed, null, 2);
                    debugJsonEl.innerHTML = highlight(pretty);
                } catch (err) {
                    debugJsonEl.textContent = 'Failed to parse analysis JSON';
                }
            }
            debugModal.classList.add('open');
            if (window.lucide) window.lucide.createIcons();
        }

        function closeDebug() {
            if (debugModal) debugModal.classList.remove('open');
        }

        if (debugBtn) debugBtn.addEventListener('click', openDebug);
        if (debugClose) debugClose.addEventListener('click', closeDebug);
        if (debugModal) {
            debugModal.addEventListener('click', (e) => {
                if (e.target === debugModal || e.target.classList.contains('debug-backdrop')) {
                    closeDebug();
                }
            });
        }
    })();

    // Coverage helpers (global fallback so inline handlers never throw)
    (function() {
        if (!window.toggleCoverageNode) {
            window.toggleCoverageNode = function(el) {
                const header = el?.closest ? el.closest('.tree-header') : null;
                const node = header?.closest ? header.closest('.tree-node') : null;
                const children = node?.querySelector ? node.querySelector('.tree-children') : null;
                const chevron = header?.querySelector ? header.querySelector('.chevron-icon') : null;
                if (!node || !children) return;
                const next = node.getAttribute('aria-expanded') !== 'true';
                node.setAttribute('aria-expanded', String(next));
                children.classList.toggle('collapsed', !next);
                children.classList.toggle('expanded', next);
                children.style.display = next ? 'block' : 'none';
                if (chevron) chevron.style.transform = next ? 'rotate(90deg)' : 'rotate(0deg)';
            };
        }

        // Path shortening (runs once on load) - keep directory parts intact
        function shortenCoveragePaths() {
            const projectRoot = {{#if project_root}}{{{json project_root}}}{{else}}""{{/if}};
            const normRoot = projectRoot ? projectRoot.replace(/\\/g, '/').replace(/\/+$/, '') : '';
            const labels = Array.from(document.querySelectorAll('.coverage-section .tree-label'));
            labels.forEach((labelEl) => {
                const raw = String(labelEl.textContent || '').trim().replace(/\\/g, '/');
                if (!raw) return;
                let display = raw;
                if (normRoot && raw.startsWith(normRoot)) {
                    display = raw.slice(normRoot.length);
                }
                display = display.replace(/^[/\\]+/, '');
                labelEl.textContent = display;
                labelEl.setAttribute('title', raw);
            });
        }

        function wireCoverageHeaders() {
            document.querySelectorAll('.coverage-section .tree-header').forEach((header) => {
                header.addEventListener('click', () => window.toggleCoverageNode(header));
                header.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        window.toggleCoverageNode(header);
                    }
                });
            });
        }

        function initCoverage() {
            shortenCoveragePaths();
            wireCoverageHeaders();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initCoverage);
        } else {
            initCoverage();
        }
    })();

    </script>
    {{#if enable_animation}}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="./webpage_files/trefoil-animation.js"></script>
    {{/if}}
</body>
</html>
