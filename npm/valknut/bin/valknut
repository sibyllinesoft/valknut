#!/usr/bin/env node

const { execFileSync } = require("child_process");
const path = require("path");
const fs = require("fs");

const PLATFORMS = {
  "linux-x64-gnu": "@sibyllinesoft/valknut-linux-x64-gnu",
  "linux-x64-musl": "@sibyllinesoft/valknut-linux-x64-musl",
  "linux-arm64-gnu": "@sibyllinesoft/valknut-linux-arm64-gnu",
  "linux-arm64-musl": "@sibyllinesoft/valknut-linux-arm64-musl",
  "darwin-x64": "@sibyllinesoft/valknut-darwin-x64",
  "darwin-arm64": "@sibyllinesoft/valknut-darwin-arm64",
  "win32-x64": "@sibyllinesoft/valknut-win32-x64",
};

function detectMusl() {
  // Check if we're running on Alpine or musl-based distro
  try {
    const output = execFileSync("ldd", ["--version"], {
      encoding: "utf8",
      stdio: ["pipe", "pipe", "pipe"],
    });
    return output.toLowerCase().includes("musl");
  } catch (e) {
    // ldd --version exits with error on musl, check stderr
    if (e.stderr && e.stderr.toLowerCase().includes("musl")) {
      return true;
    }
    // Fallback: check /etc/os-release for Alpine
    try {
      const osRelease = fs.readFileSync("/etc/os-release", "utf8");
      return osRelease.toLowerCase().includes("alpine");
    } catch {
      return false;
    }
  }
}

function getPlatformKey() {
  const platform = process.platform;
  const arch = process.arch;

  if (platform === "win32" && arch === "x64") {
    return "win32-x64";
  }

  if (platform === "darwin") {
    return `darwin-${arch}`;
  }

  if (platform === "linux") {
    const libc = detectMusl() ? "musl" : "gnu";
    return `linux-${arch}-${libc}`;
  }

  return null;
}

function findBinary() {
  const platformKey = getPlatformKey();

  if (!platformKey) {
    console.error(
      `Unsupported platform: ${process.platform}-${process.arch}`
    );
    console.error("Supported platforms: " + Object.keys(PLATFORMS).join(", "));
    process.exit(1);
  }

  const packageName = PLATFORMS[platformKey];
  const binaryName = process.platform === "win32" ? "valknut.exe" : "valknut";

  // Try to find the binary in node_modules
  const possiblePaths = [
    // Installed as dependency
    path.join(__dirname, "..", "..", packageName, binaryName),
    // Hoisted in node_modules
    path.join(__dirname, "..", "..", "..", packageName, binaryName),
    // pnpm/yarn PnP style
    path.join(
      __dirname,
      "..",
      "node_modules",
      packageName,
      binaryName
    ),
  ];

  for (const binPath of possiblePaths) {
    if (fs.existsSync(binPath)) {
      return binPath;
    }
  }

  // Try require.resolve as fallback
  try {
    const packagePath = require.resolve(`${packageName}/package.json`);
    const binPath = path.join(path.dirname(packagePath), binaryName);
    if (fs.existsSync(binPath)) {
      return binPath;
    }
  } catch {
    // Package not installed
  }

  console.error(`Could not find valknut binary for ${platformKey}`);
  console.error(`Expected package: ${packageName}`);
  console.error("");
  console.error("This may happen if:");
  console.error("  1. Your platform is not supported");
  console.error("  2. The optional dependency failed to install");
  console.error("");
  console.error("Try reinstalling with:");
  console.error("  npm install @sibyllinesoft/valknut");
  process.exit(1);
}

const binary = findBinary();
const args = process.argv.slice(2);

try {
  const result = execFileSync(binary, args, {
    stdio: "inherit",
    encoding: "utf8",
  });
} catch (e) {
  if (e.status !== undefined) {
    process.exit(e.status);
  }
  throw e;
}
