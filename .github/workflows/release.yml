name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (skip publishing)'
        required: false
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      dry_run: ${{ steps.version.outputs.dry_run }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            DRY_RUN="${{ github.event.inputs.dry_run }}"
          else
            VERSION="${{ github.ref_name }}"
            DRY_RUN="false"
          fi

          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
            echo "‚ùå Invalid version format: $VERSION"
            exit 1
          fi

          IS_PRERELEASE="false"
          if [[ "$VERSION" =~ -[a-zA-Z0-9]+(\.[0-9]+)?$ ]]; then
            IS_PRERELEASE="true"
          fi

          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "tag=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "dry_run=$DRY_RUN" >> $GITHUB_OUTPUT
          echo "üì¶ Release: ${VERSION#v} (prerelease: $IS_PRERELEASE, dry_run: $DRY_RUN)"

  build:
    name: Build (${{ matrix.target }})
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        include:
          # Native builds (fast and reliable)
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            name: valknut-x86_64-linux-gnu
            cross: false
            features: ""
          - target: x86_64-apple-darwin
            os: macos-13
            name: valknut-x86_64-macos
            cross: false
            features: "vendored-openssl"
          - target: aarch64-apple-darwin
            os: macos-latest
            name: valknut-aarch64-macos
            cross: false
            features: "vendored-openssl"
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            name: valknut-x86_64-windows.exe
            cross: false
            features: ""
          # Cross-compiled builds (disabled for now - need cross Docker configuration)
          # - target: x86_64-unknown-linux-musl
          #   os: ubuntu-latest
          #   name: valknut-x86_64-linux-musl
          #   cross: true
          #   features: ""
          # - target: aarch64-unknown-linux-gnu
          #   os: ubuntu-latest
          #   name: valknut-aarch64-linux-gnu
          #   cross: true
          #   features: ""
          # - target: aarch64-unknown-linux-musl
          #   os: ubuntu-latest
          #   name: valknut-aarch64-linux-musl
          #   cross: true
          #   features: ""

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install OpenSSL (Linux native)
        if: matrix.os == 'ubuntu-latest' && matrix.cross == false
        run: sudo apt-get update && sudo apt-get install -y libssl-dev pkg-config

      - name: Install OpenSSL (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          echo "Installing OpenSSL via vcpkg"
          vcpkg install openssl:x64-windows-static-md
          echo "OPENSSL_DIR=C:\vcpkg\installed\x64-windows-static-md" >> $GITHUB_ENV
          echo "OPENSSL_STATIC=1" >> $GITHUB_ENV
        shell: bash

      - name: Setup cross
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Cache
        uses: Swatinem/rust-cache@v2
        with:
          key: release-${{ matrix.target }}

      - name: Build
        shell: bash
        run: |
          FEATURES="${{ matrix.features }}"
          FEATURE_FLAGS=""
          if [ -n "$FEATURES" ]; then
            FEATURE_FLAGS="--features $FEATURES"
          fi

          if [ "${{ matrix.cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }} --bin valknut $FEATURE_FLAGS
          else
            cargo build --release --target ${{ matrix.target }} --bin valknut $FEATURE_FLAGS
          fi

      - name: Package
        shell: bash
        run: |
          mkdir -p artifacts
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            cp target/${{ matrix.target }}/release/valknut.exe artifacts/${{ matrix.name }}
          else
            cp target/${{ matrix.target }}/release/valknut artifacts/${{ matrix.name }}
          fi
          cd artifacts
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            certutil -hashfile ${{ matrix.name }} SHA256 > ${{ matrix.name }}.sha256
          else
            shasum -a 256 ${{ matrix.name }} > ${{ matrix.name }}.sha256
          fi

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.target }}
          path: artifacts/

  release:
    name: GitHub Release
    needs: [validate, build]
    if: needs.validate.outputs.dry_run != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: binary-*
          path: artifacts/
          merge-multiple: true

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate.outputs.tag }}
          name: "Valknut ${{ needs.validate.outputs.version }}"
          files: artifacts/*
          prerelease: ${{ needs.validate.outputs.is_prerelease }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-npm:
    name: Publish npm
    needs: [validate, build]
    if: needs.validate.outputs.dry_run != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: binary-*
          path: artifacts/
          merge-multiple: true

      - name: Prepare packages
        run: |
          VERSION="${{ needs.validate.outputs.version }}"

          # Map artifact names to npm package suffixes
          declare -A ARTIFACT_MAP=(
            ["valknut-x86_64-linux-gnu"]="linux-x64-gnu"
            ["valknut-x86_64-macos"]="darwin-x64"
            ["valknut-aarch64-macos"]="darwin-arm64"
            ["valknut-x86_64-windows.exe"]="win32-x64"
          )

          for artifact in "${!ARTIFACT_MAP[@]}"; do
            npm_dir="${ARTIFACT_MAP[$artifact]}"
            if [ -f "artifacts/$artifact" ]; then
              if [[ "$artifact" == *.exe ]]; then
                cp "artifacts/$artifact" "npm/valknut-$npm_dir/valknut.exe"
              else
                cp "artifacts/$artifact" "npm/valknut-$npm_dir/valknut"
                chmod +x "npm/valknut-$npm_dir/valknut"
              fi
            fi
          done

          # Update versions
          for pkg_dir in npm/valknut-*/; do
            jq --arg v "$VERSION" '.version = $v' "$pkg_dir/package.json" > "$pkg_dir/package.json.tmp"
            mv "$pkg_dir/package.json.tmp" "$pkg_dir/package.json"
          done

          jq --arg v "$VERSION" '
            .version = $v |
            .optionalDependencies = (.optionalDependencies | to_entries | map(.value = $v) | from_entries)
          ' npm/valknut/package.json > npm/valknut/package.json.tmp
          mv npm/valknut/package.json.tmp npm/valknut/package.json

      - name: Publish platform packages
        if: env.NPM_TOKEN != ''
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          for pkg_dir in npm/valknut-*/; do
            cd "$pkg_dir"
            npm publish --access public || true
            cd - > /dev/null
          done

      - name: Publish main package
        if: env.NPM_TOKEN != ''
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd npm/valknut
          npm publish --access public

      - name: Skip (no token)
        if: env.NPM_TOKEN == ''
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: echo "‚ö†Ô∏è NPM_TOKEN not set, skipping npm publish"

  publish-crates:
    name: Publish crates.io
    needs: [validate, release]
    if: needs.validate.outputs.is_prerelease != 'true' && needs.validate.outputs.dry_run != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish
        if: env.CARGO_REGISTRY_TOKEN != ''
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Skip (no token)
        if: env.CARGO_REGISTRY_TOKEN == ''
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: echo "‚ö†Ô∏è CARGO_REGISTRY_TOKEN not set, skipping crates.io publish"
